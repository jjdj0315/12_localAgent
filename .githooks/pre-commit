#!/bin/bash
#
# Pre-commit hook: UTF-8 encoding validation (T303, FR-115)
#
# This hook validates that all source files are UTF-8 encoded
# to prevent Korean text corruption (mojibake issues).
#
# Checked file types: .py, .ts, .tsx, .js, .jsx, .md, .json
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "🔍 UTF-8 인코딩 검증 중..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Exit if no files staged
if [ -z "$STAGED_FILES" ]; then
    echo "✅ 검증할 파일이 없습니다."
    exit 0
fi

# File extensions to check
EXTENSIONS="py|ts|tsx|js|jsx|md|json"

# Track validation failures
HAS_ERRORS=0
ERROR_FILES=()

# Check each staged file
while IFS= read -r file; do
    # Skip deleted files
    if [ ! -f "$file" ]; then
        continue
    fi

    # Check if file matches extensions
    if echo "$file" | grep -qE "\.(${EXTENSIONS})$"; then
        # Use file command to detect encoding
        # Look for "UTF-8" in output
        FILE_INFO=$(file -b "$file")

        # Check if file is UTF-8
        if ! echo "$FILE_INFO" | grep -q "UTF-8"; then
            # If it's ASCII, it's OK (subset of UTF-8)
            if echo "$FILE_INFO" | grep -q "ASCII"; then
                continue
            fi

            # If it's empty or data file, skip
            if echo "$FILE_INFO" | grep -qE "(empty|data)"; then
                continue
            fi

            # Otherwise, it's an encoding error
            echo -e "${RED}❌ 인코딩 오류: $file${NC}"
            echo -e "   감지된 인코딩: $FILE_INFO"
            echo -e "   예상 인코딩: UTF-8"
            ERROR_FILES+=("$file")
            HAS_ERRORS=1
        fi

        # Additional check: look for mojibake patterns in Python/TypeScript files
        if echo "$file" | grep -qE "\.(py|ts|tsx)$"; then
            # Check for common mojibake sequences (������, etc.)
            if grep -qP '[\x80-\xFF]{3,}' "$file" 2>/dev/null; then
                # Verify it's not legitimate UTF-8 by checking for Korean characters
                if ! grep -qP '[\x{AC00}-\x{D7A3}]' "$file" 2>/dev/null; then
                    echo -e "${YELLOW}⚠️  의심스러운 바이트 시퀀스 발견: $file${NC}"
                    echo -e "   파일에 깨진 한글 텍스트가 있을 수 있습니다."
                fi
            fi
        fi
    fi
done <<< "$STAGED_FILES"

# Report results
if [ $HAS_ERRORS -eq 1 ]; then
    echo ""
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}❌ UTF-8 인코딩 검증 실패${NC}"
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "다음 파일들의 인코딩이 UTF-8이 아닙니다:"
    for file in "${ERROR_FILES[@]}"; do
        echo "  - $file"
    done
    echo ""
    echo "해결 방법:"
    echo "  1. VSCode: 파일을 열고 우측 하단의 인코딩을 클릭 → 'UTF-8로 저장'"
    echo "  2. 명령줄: iconv -f ENCODING -t UTF-8 파일명 > 파일명.utf8"
    echo "  3. Git: git add 후 다시 커밋"
    echo ""
    echo "참고: T302에서 errorMessages.ts의 한글 인코딩 손상 사례 참조"
    echo ""
    exit 1
fi

echo -e "${GREEN}✅ 모든 파일이 UTF-8로 인코딩되어 있습니다.${NC}"
exit 0
