#!/bin/bash
#
# Pre-commit hook for UTF-8 encoding validation (T303, FR-115)
#
# Purpose: Prevent commits with invalid UTF-8 encoding in TypeScript files
# Installation: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Validating UTF-8 encoding for TypeScript files..."

# Find all staged .ts and .tsx files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' || true)

if [ -z "$STAGED_TS_FILES" ]; then
    echo -e "${GREEN}‚úì No TypeScript files to validate${NC}"
    exit 0
fi

# Validation results
INVALID_FILES=()
TOTAL_FILES=0

# Validate each file
for file in $STAGED_TS_FILES; do
    if [ -f "$file" ]; then
        TOTAL_FILES=$((TOTAL_FILES + 1))

        # Use iconv to validate UTF-8 encoding
        if ! iconv -f UTF-8 -t UTF-8 "$file" > /dev/null 2>&1; then
            INVALID_FILES+=("$file")
            echo -e "${RED}‚úó $file - Invalid UTF-8 encoding${NC}"
        else
            # Additional check for BOM
            if file "$file" | grep -q "with BOM"; then
                echo -e "${YELLOW}‚ö† $file - Contains BOM (not recommended)${NC}"
            fi
        fi
    fi
done

# Report results
echo ""
echo "=== Validation Results ==="
echo "Total files checked: $TOTAL_FILES"
echo -e "Invalid files: ${#INVALID_FILES[@]}"

if [ ${#INVALID_FILES[@]} -gt 0 ]; then
    echo ""
    echo -e "${RED}‚ùå COMMIT BLOCKED${NC}"
    echo ""
    echo "The following files have invalid UTF-8 encoding:"
    for file in "${INVALID_FILES[@]}"; do
        echo "  - $file"
    done
    echo ""
    echo "Fix encoding issues:"
    echo "  1. Open file in editor with UTF-8 encoding"
    echo "  2. Re-save file as UTF-8 (no BOM)"
    echo "  3. Verify with: file \$file"
    echo ""
    exit 1
fi

# Check for mojibake patterns
MOJIBAKE_PATTERN='ÔøΩ'
ERROR_MSG_FILES=$(echo "$STAGED_TS_FILES" | grep -i "error" | grep -E '\.(ts|tsx)$' || true)

if [ -n "$ERROR_MSG_FILES" ]; then
    for file in $ERROR_MSG_FILES; do
        if grep -q "$MOJIBAKE_PATTERN" "$file" 2>/dev/null; then
            echo -e "${RED}‚úó $file - Contains mojibake characters (ÔøΩ)${NC}"
            echo ""
            echo -e "${RED}‚ùå COMMIT BLOCKED${NC}"
            echo "Korean text is corrupted in $file"
            exit 1
        fi
    done
fi

echo -e "${GREEN}‚úì All TypeScript files have valid UTF-8 encoding${NC}"
exit 0
